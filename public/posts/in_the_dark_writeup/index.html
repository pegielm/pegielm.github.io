<!DOCTYPE html>
<html><head lang="en"><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>in the dark writeup - pegielm</title><link rel="icon" type="image/png" href=https://img.icons8.com/?size&#61;100&amp;id&#61;16133&amp;format&#61;png&amp;color&#61;000000 /><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="writeup of the in the dark challenge from zeroday ctf (which I created)" />
	<meta property="og:image" content=""/>
	<meta property="og:url" content="http://localhost:1313/posts/in_the_dark_writeup/">
  <meta property="og:site_name" content="pegielm">
  <meta property="og:title" content="in the dark writeup">
  <meta property="og:description" content="writeup of the in the dark challenge from zeroday ctf (which I created)">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-12-03T00:00:00+00:00">
    <meta property="article:modified_time" content="2024-12-03T00:00:00+00:00">
    <meta property="article:tag" content="Ctf">
    <meta property="article:tag" content="Rev">
    <meta property="article:tag" content="Zeroday">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="in the dark writeup">
  <meta name="twitter:description" content="writeup of the in the dark challenge from zeroday ctf (which I created)">
<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
	<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@1,500&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Fira+Sans&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Roboto+Mono" rel="stylesheet">

	
	<link rel="stylesheet" type="text/css" media="screen" href="http://localhost:1313/css/main.d902908ac6e0fab67957de5db5aea1b6455b19ae2ca98eac4c95a4a0fdc02238.css" />
		<link id="darkModeStyle" rel="stylesheet" type="text/css" href="http://localhost:1313/css/dark.c95c5dcf5f32f8b67bd36f7dab66680e068fce2b303087294114aabf7a7c080b.css"  disabled />
	

	
	

	
	
	
	
</head>
<body>
        <div class="content"><header>
	<div class="main">
		<a href="http://localhost:1313/">pegielm</a>
	</div>
	<nav>
		
		<a href="/">home</a>
		
		<a href="/posts">all posts</a>
		
		<a href="/about">about me</a>
		
		<a href="/tags">tags</a>
		
		| <span id="dark-mode-toggle" onclick="toggleTheme()"></span>
		<script src="http://localhost:1313/js/themetoggle.js"></script>
		
	</nav>
</header>

<main>
	<article>
		<div class="title">
			<h1 class="title">in the dark writeup</h1>
			<div class="meta">Posted on Dec 3, 2024</div>
		</div>
		

		<section class="body">
			<h1 id="challenge-description">Challenge description</h1>
<p>A lone mage, lost in the abyss of darkness awaits aid. Only a experienced wizard can guide him, perceiving what mortal eyes cannot see&hellip;</p>
<p>files :</p>
<p><a href="/files/in_the_dark/chall">chall</a></p>
<p>or you can build it from source:</p>
<p><a href="/files/in_the_dark/source.c">source.c</a></p>
<p>you need to compile it with:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gcc source.c -lssl -lcrypto -o chall
</span></span></code></pre></div><h1 id="solution">Solution</h1>
<ol>
<li>
<p>open chall in ida</p>
</li>
<li>
<p>in move_right() function (or any other) there is variable &lsquo;MAP&rsquo;</p>
</li>
<li>
<p>after inspecting the &lsquo;MAP&rsquo; (right click -&gt; array -&gt; turn off &lsquo;Use dup construnct&rsquo;) we can see (or in gdb &lsquo;x/100x (int*)&amp;MAP&rsquo;):</p>
</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>.rodata:0000000000002040 MAP             db 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0
</span></span><span style="display:flex;"><span>.rodata:0000000000002040                                         ; DATA XREF: gravity+3F↑o
</span></span><span style="display:flex;"><span>.rodata:0000000000002040                                         ; move_right+2E↑o ...
</span></span><span style="display:flex;"><span>.rodata:0000000000002052                 db 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 2, 2, 2, 2
</span></span><span style="display:flex;"><span>.rodata:0000000000002064                 db 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1
</span></span><span style="display:flex;"><span>.rodata:0000000000002076                 db 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 1, 0
</span></span><span style="display:flex;"><span>.rodata:0000000000002088                 db 0, 1, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0
</span></span><span style="display:flex;"><span>.rodata:000000000000209A                 db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0
</span></span><span style="display:flex;"><span>.rodata:00000000000020AC                 db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1
</span></span><span style="display:flex;"><span>.rodata:00000000000020BE                 db 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 1
</span></span><span style="display:flex;"><span>.rodata:00000000000020D0                 db 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0
</span></span><span style="display:flex;"><span>.rodata:00000000000020E2                 db 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0
</span></span><span style="display:flex;"><span>.rodata:00000000000020F4                 db 1, 1, 0, 0, 0, 0, 2, 1, 1, 0, 0, 0, 1, 1, 1, 1, 0, 0
</span></span><span style="display:flex;"><span>.rodata:0000000000002106                 db 1, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0
</span></span><span style="display:flex;"><span>.rodata:0000000000002118                 db 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 2, 2, 1, 9
</span></span><span style="display:flex;"><span>.rodata:000000000000212A                 db 0, 0, 0, 0, 0, 0, 1, 1, 0, 1, 0, 0, 2, 0, 0, 1, 1, 1
</span></span><span style="display:flex;"><span>.rodata:000000000000213C                 db 1, 1, 1, 1, 1, 0, 0, 1, 2, 2, 1, 1, 1, 1, 1, 1, 1, 0
</span></span><span style="display:flex;"><span>.rodata:000000000000214E                 db 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2
</span></span><span style="display:flex;"><span>.rodata:0000000000002160                 db 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0
</span></span></code></pre></div><p>also in</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>.rodata:0000000000002020 MAX_X           db  1Eh
</span></span><span style="display:flex;"><span>.rodata:0000000000002024 MAX_Y           db  0Ah
</span></span></code></pre></div><p>MAX_X = 30 and MAX_Y = 10 we got map size 30x10</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>.data:0000000000004010 p_y             dd 7                    ; DATA XREF: gravity:loc_126F↑r
</span></span><span style="display:flex;"><span>.data:0000000000004014 g_x             dd 0Bh                  ; DATA XREF: goblin_move+8↑r
</span></span><span style="display:flex;"><span>.data:0000000000004018 g_y             dd 7                    ; DATA XREF: goblin_move+18↑r
</span></span><span style="display:flex;"><span>.data:000000000000401C g_dir           dd 1                    ; DATA XREF: goblin_move+50↑r
</span></span></code></pre></div><p>also from gdb:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>pwndbg&gt; x/d (int*)&amp;p_x
</span></span><span style="display:flex;"><span>0x555555558024 &lt;p_x&gt;:   0
</span></span><span style="display:flex;"><span>pwndbg&gt; x/d (int*)&amp;p_y
</span></span><span style="display:flex;"><span>0x555555558010 &lt;p_y&gt;:   7
</span></span><span style="display:flex;"><span>pwndbg&gt; x/d (int*)&amp;g_x
</span></span><span style="display:flex;"><span>0x555555558014 &lt;g_x&gt;:   11
</span></span><span style="display:flex;"><span>pwndbg&gt; x/d (int*)&amp;g_y
</span></span><span style="display:flex;"><span>0x555555558018 &lt;g_y&gt;:   7
</span></span><span style="display:flex;"><span>pwndbg&gt; x/d (int*)&amp;g_dir
</span></span><span style="display:flex;"><span>0x55555555801c &lt;g_dir&gt;: 1
</span></span></code></pre></div><p>so starting position of player is (0, 7) and goblin (11, 7) with direction 1 (right - direction is just added to x when moving)</p>
<ol start="3">
<li>from this data we can construct the map with python script:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> PIL <span style="color:#f92672">import</span> Image
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">draw_map</span>(map, p_x, p_y, g_x, g_y):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> map:
</span></span><span style="display:flex;"><span>        print(i)
</span></span><span style="display:flex;"><span>    colors <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">0</span>: (<span style="color:#ae81ff">255</span>, <span style="color:#ae81ff">255</span>, <span style="color:#ae81ff">255</span>),  <span style="color:#75715e"># white</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">1</span>: (<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>),        <span style="color:#75715e"># black</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">2</span>: (<span style="color:#ae81ff">255</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>),      <span style="color:#75715e"># red</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">9</span>: (<span style="color:#ae81ff">255</span>,<span style="color:#ae81ff">255</span>,<span style="color:#ae81ff">0</span>)       <span style="color:#75715e">#yellow</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    img <span style="color:#f92672">=</span> Image<span style="color:#f92672">.</span>new(<span style="color:#e6db74">&#39;RGB&#39;</span>, (MAX_X, MAX_Y), color<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;white&#39;</span>)
</span></span><span style="display:flex;"><span>    pixels <span style="color:#f92672">=</span> img<span style="color:#f92672">.</span>load()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> y <span style="color:#f92672">in</span> range(MAX_Y):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> range(MAX_X):
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> y <span style="color:#f92672">&lt;</span> len(map) <span style="color:#f92672">and</span> x <span style="color:#f92672">&lt;</span> len(map[y]):
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> x <span style="color:#f92672">==</span> p_x <span style="color:#f92672">and</span> y <span style="color:#f92672">==</span> p_y:
</span></span><span style="display:flex;"><span>                    pixels[x, y] <span style="color:#f92672">=</span> (<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">255</span>)  <span style="color:#75715e"># blue</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">elif</span> x <span style="color:#f92672">==</span> g_x <span style="color:#f92672">and</span> y <span style="color:#f92672">==</span> g_y:
</span></span><span style="display:flex;"><span>                    pixels[x, y] <span style="color:#f92672">=</span> (<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">255</span>, <span style="color:#ae81ff">0</span>) <span style="color:#75715e"># green</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                    pixels[x, y] <span style="color:#f92672">=</span> colors<span style="color:#f92672">.</span>get(map[y][x], (<span style="color:#ae81ff">255</span>, <span style="color:#ae81ff">255</span>, <span style="color:#ae81ff">255</span>))
</span></span><span style="display:flex;"><span>    img <span style="color:#f92672">=</span> img<span style="color:#f92672">.</span>resize((MAX_X <span style="color:#f92672">*</span> <span style="color:#ae81ff">10</span>, MAX_Y <span style="color:#f92672">*</span> <span style="color:#ae81ff">10</span>), Image<span style="color:#f92672">.</span>NEAREST)
</span></span><span style="display:flex;"><span>    img<span style="color:#f92672">.</span>save(<span style="color:#e6db74">&#39;map.png&#39;</span>)
</span></span><span style="display:flex;"><span>    img<span style="color:#f92672">.</span>show()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ida_dump <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;&#39;.rodata:0000000000002040 MAP             db 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">.rodata:0000000000002040                                         ; DATA XREF: gravity+3F↑o
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">.rodata:0000000000002040                                         ; move_right+2E↑o ...
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">.rodata:0000000000002052                 db 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 2, 2, 2, 2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">.rodata:0000000000002064                 db 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">.rodata:0000000000002076                 db 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 1, 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">.rodata:0000000000002088                 db 0, 1, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">.rodata:000000000000209A                 db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">.rodata:00000000000020AC                 db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">.rodata:00000000000020BE                 db 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">.rodata:00000000000020D0                 db 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">.rodata:00000000000020E2                 db 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">.rodata:00000000000020F4                 db 1, 1, 0, 0, 0, 0, 2, 1, 1, 0, 0, 0, 1, 1, 1, 1, 0, 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">.rodata:0000000000002106                 db 1, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">.rodata:0000000000002118                 db 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 2, 2, 1, 9
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">.rodata:000000000000212A                 db 0, 0, 0, 0, 0, 0, 1, 1, 0, 1, 0, 0, 2, 0, 0, 1, 1, 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">.rodata:000000000000213C                 db 1, 1, 1, 1, 1, 0, 0, 1, 2, 2, 1, 1, 1, 1, 1, 1, 1, 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">.rodata:000000000000214E                 db 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">.rodata:0000000000002160                 db 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>tmp <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>MAX_X <span style="color:#f92672">=</span> <span style="color:#ae81ff">30</span>
</span></span><span style="display:flex;"><span>MAX_Y <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>p_x <span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>p_y <span style="color:#f92672">=</span> <span style="color:#ae81ff">7</span>
</span></span><span style="display:flex;"><span>g_x <span style="color:#f92672">=</span> <span style="color:#ae81ff">11</span>
</span></span><span style="display:flex;"><span>g_y <span style="color:#f92672">=</span> <span style="color:#ae81ff">7</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> line <span style="color:#f92672">in</span> ida_dump<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#39;db&#39;</span> <span style="color:#f92672">in</span> line:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> line<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;db &#39;</span>)[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;, &#39;</span>):
</span></span><span style="display:flex;"><span>            tmp<span style="color:#f92672">.</span>append(int(i))
</span></span><span style="display:flex;"><span>map <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>, len(tmp), MAX_X):
</span></span><span style="display:flex;"><span>    map<span style="color:#f92672">.</span>append(tmp[i:i<span style="color:#f92672">+</span>MAX_X])
</span></span><span style="display:flex;"><span>map<span style="color:#f92672">.</span>pop() <span style="color:#75715e"># remove last null bytes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>draw_map(map, p_x, p_y, g_x, g_y)
</span></span></code></pre></div><p><img src="/files/in_the_dark/start.png" alt="map.png"></p>
<p>black - walls, red - lava, green - goblin, yellow - flag (from touching_lava(),goblin_move() and on_flag functions)</p>
<ol start="4">
<li>after inspecting move_right(), move_left(), jump_left(), jump_right() (from decode_moves()) we can see what moves are allowed:</li>
</ol>
<p>&lsquo;a&rsquo; - move_left() - one step left</p>
<p>&rsquo;d&rsquo; - move_right() - one step right</p>
<p>&lsquo;wa&rsquo; - jump_left() - two vertical-up steps left</p>
<p>&lsquo;wd&rsquo; - jump_right() - two vertical-up steps right</p>
<p>also we have only 43 moves (chars) to use</p>
<p>other functions:</p>
<ul>
<li>gravity() - after each move player is moved down if possible</li>
<li>touching_lava() - if player is on lava (red) loose</li>
<li>on_flag() - if player is on flag (green) win and print flag from hashed input xored with secret key</li>
<li>goblin_move() - goblin moves in his direction if encounters player he kills him, if encounters hollow space he changes direction</li>
</ul>
<ol start="5">
<li>we need to simulate possible moves and how goblin&rsquo;s position changes:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> PIL <span style="color:#f92672">import</span> Image
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">draw_map</span>(map, p_x, p_y, g_x, g_y,filename<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;map.png&#39;</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#for i in map:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#    print(i)</span>
</span></span><span style="display:flex;"><span>    colors <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">0</span>: (<span style="color:#ae81ff">255</span>, <span style="color:#ae81ff">255</span>, <span style="color:#ae81ff">255</span>),  <span style="color:#75715e"># white</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">1</span>: (<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>),        <span style="color:#75715e"># black</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">2</span>: (<span style="color:#ae81ff">255</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>),      <span style="color:#75715e"># red</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">9</span>: (<span style="color:#ae81ff">255</span>,<span style="color:#ae81ff">255</span>,<span style="color:#ae81ff">0</span>)       <span style="color:#75715e">#yellow</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    img <span style="color:#f92672">=</span> Image<span style="color:#f92672">.</span>new(<span style="color:#e6db74">&#39;RGB&#39;</span>, (MAX_X, MAX_Y), color<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;white&#39;</span>)
</span></span><span style="display:flex;"><span>    pixels <span style="color:#f92672">=</span> img<span style="color:#f92672">.</span>load()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> y <span style="color:#f92672">in</span> range(MAX_Y):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> range(MAX_X):
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> y <span style="color:#f92672">&lt;</span> len(map) <span style="color:#f92672">and</span> x <span style="color:#f92672">&lt;</span> len(map[y]):
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> x <span style="color:#f92672">==</span> p_x <span style="color:#f92672">and</span> y <span style="color:#f92672">==</span> p_y:
</span></span><span style="display:flex;"><span>                    pixels[x, y] <span style="color:#f92672">=</span> (<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">255</span>)  <span style="color:#75715e"># blue</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">elif</span> x <span style="color:#f92672">==</span> g_x <span style="color:#f92672">and</span> y <span style="color:#f92672">==</span> g_y:
</span></span><span style="display:flex;"><span>                    pixels[x, y] <span style="color:#f92672">=</span> (<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">255</span>, <span style="color:#ae81ff">0</span>) <span style="color:#75715e"># green</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                    pixels[x, y] <span style="color:#f92672">=</span> colors<span style="color:#f92672">.</span>get(map[y][x], (<span style="color:#ae81ff">255</span>, <span style="color:#ae81ff">255</span>, <span style="color:#ae81ff">255</span>))
</span></span><span style="display:flex;"><span>    img <span style="color:#f92672">=</span> img<span style="color:#f92672">.</span>resize((MAX_X <span style="color:#f92672">*</span> <span style="color:#ae81ff">10</span>, MAX_Y <span style="color:#f92672">*</span> <span style="color:#ae81ff">10</span>), Image<span style="color:#f92672">.</span>NEAREST)
</span></span><span style="display:flex;"><span>    img<span style="color:#f92672">.</span>save(filename)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#img.show()</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">goblin_move</span>(map,g_x,g_y,g_dir):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> map[g_y<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>][g_x<span style="color:#f92672">+</span>g_dir] <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>        g_dir <span style="color:#f92672">*=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        g_x <span style="color:#f92672">+=</span> g_dir
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        g_x <span style="color:#f92672">+=</span> g_dir
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> g_x, g_y, g_dir
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">gravity</span>(map, p_x, p_y):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span>(p_y <span style="color:#f92672">&lt;</span> MAX_Y <span style="color:#f92672">and</span> map[p_y<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>][p_x] <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>):
</span></span><span style="display:flex;"><span>        p_y <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> p_x, p_y
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">move_right</span>(map, p_x, p_y):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> p_x <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>, p_y
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">move_left</span>(map, p_x, p_y):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> p_x <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>, p_y
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">jump_right</span>(map, p_x, p_y):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> p_x <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span>, p_y <span style="color:#f92672">-</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">jump_left</span>(map, p_x, p_y):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> p_x <span style="color:#f92672">-</span> <span style="color:#ae81ff">2</span>, p_y <span style="color:#f92672">-</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">decode_moves</span>(moves, map, p_x, p_y, g_x, g_y,g_dir):
</span></span><span style="display:flex;"><span>    i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> i <span style="color:#f92672">&lt;</span> len(moves): 
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> moves[i] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;d&#39;</span>:
</span></span><span style="display:flex;"><span>            p_x,p_y <span style="color:#f92672">=</span> move_right(map, p_x, p_y)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> moves[i] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;a&#39;</span>:
</span></span><span style="display:flex;"><span>            p_x,p_y <span style="color:#f92672">=</span> move_left(map, p_x, p_y)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> moves[i] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;w&#39;</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> moves[i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;d&#39;</span>:
</span></span><span style="display:flex;"><span>                p_x,p_y <span style="color:#f92672">=</span> jump_right(map, p_x, p_y)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">elif</span> moves[i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;a&#39;</span>:
</span></span><span style="display:flex;"><span>                p_x,p_y <span style="color:#f92672">=</span> jump_left(map, p_x, p_y)
</span></span><span style="display:flex;"><span>            i <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        i <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        p_x, p_y <span style="color:#f92672">=</span> gravity(map, p_x, p_y)
</span></span><span style="display:flex;"><span>        g_x,g_y,g_dir <span style="color:#f92672">=</span> goblin_move(map,g_x,g_y,g_dir)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> p_x, p_y, g_x, g_y, g_dir
</span></span><span style="display:flex;"><span>ida_dump <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;&#39;.rodata:0000000000002040 MAP             db 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">.rodata:0000000000002040                                         ; DATA XREF: gravity+3F↑o
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">.rodata:0000000000002040                                         ; move_right+2E↑o ...
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">.rodata:0000000000002052                 db 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 2, 2, 2, 2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">.rodata:0000000000002064                 db 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">.rodata:0000000000002076                 db 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 1, 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">.rodata:0000000000002088                 db 0, 1, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">.rodata:000000000000209A                 db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">.rodata:00000000000020AC                 db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">.rodata:00000000000020BE                 db 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">.rodata:00000000000020D0                 db 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">.rodata:00000000000020E2                 db 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">.rodata:00000000000020F4                 db 1, 1, 0, 0, 0, 0, 2, 1, 1, 0, 0, 0, 1, 1, 1, 1, 0, 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">.rodata:0000000000002106                 db 1, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">.rodata:0000000000002118                 db 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 2, 2, 1, 9
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">.rodata:000000000000212A                 db 0, 0, 0, 0, 0, 0, 1, 1, 0, 1, 0, 0, 2, 0, 0, 1, 1, 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">.rodata:000000000000213C                 db 1, 1, 1, 1, 1, 0, 0, 1, 2, 2, 1, 1, 1, 1, 1, 1, 1, 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">.rodata:000000000000214E                 db 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">.rodata:0000000000002160                 db 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>tmp <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>MAX_X <span style="color:#f92672">=</span> <span style="color:#ae81ff">30</span>
</span></span><span style="display:flex;"><span>MAX_Y <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>p_x <span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>p_y <span style="color:#f92672">=</span> <span style="color:#ae81ff">7</span>
</span></span><span style="display:flex;"><span>g_x <span style="color:#f92672">=</span> <span style="color:#ae81ff">11</span>
</span></span><span style="display:flex;"><span>g_y <span style="color:#f92672">=</span> <span style="color:#ae81ff">7</span>
</span></span><span style="display:flex;"><span>g_dir <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> line <span style="color:#f92672">in</span> ida_dump<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#39;db&#39;</span> <span style="color:#f92672">in</span> line:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> line<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;db &#39;</span>)[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;, &#39;</span>):
</span></span><span style="display:flex;"><span>            tmp<span style="color:#f92672">.</span>append(int(i))
</span></span><span style="display:flex;"><span>map <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>, len(tmp), MAX_X):
</span></span><span style="display:flex;"><span>    map<span style="color:#f92672">.</span>append(tmp[i:i<span style="color:#f92672">+</span>MAX_X])
</span></span><span style="display:flex;"><span>map<span style="color:#f92672">.</span>pop() <span style="color:#75715e"># remove last null bytes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>draw_map(map, p_x, p_y, g_x, g_y,filename<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;start.png&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>moves1 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;dwdwaawddddwddd&#39;</span>
</span></span><span style="display:flex;"><span>p_x, p_y, g_x, g_y, g_dir <span style="color:#f92672">=</span> decode_moves(moves1, map, p_x, p_y, g_x, g_y,g_dir)
</span></span><span style="display:flex;"><span>draw_map(map, p_x, p_y, g_x, g_y, filename<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;before_goblin.png&#39;</span>)
</span></span><span style="display:flex;"><span>moves2 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;wd&#39;</span>
</span></span><span style="display:flex;"><span>p_x, p_y, g_x, g_y, g_dir <span style="color:#f92672">=</span> decode_moves(moves2, map, p_x, p_y, g_x, g_y,g_dir)
</span></span><span style="display:flex;"><span>draw_map(map, p_x, p_y, g_x, g_y, filename<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;after_goblin.png&#39;</span>)
</span></span><span style="display:flex;"><span>moves3 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;dddddwdwawddddddwdwddaaaaa&#39;</span>
</span></span><span style="display:flex;"><span>p_x, p_y, g_x, g_y, g_dir <span style="color:#f92672">=</span> decode_moves(moves3, map, p_x, p_y, g_x, g_y,g_dir)
</span></span><span style="display:flex;"><span>draw_map(map, p_x, p_y, g_x, g_y, filename<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;final.png&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(moves1<span style="color:#f92672">+</span>moves2<span style="color:#f92672">+</span>moves3)
</span></span></code></pre></div><p>output:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>dwdwaawddddwdddwddddddwdwawddddddwdwddaaaaa
</span></span></code></pre></div><p>Stages:</p>
<p>starting position</p>
<p><img src="/files/in_the_dark/start.png" alt="start.png"></p>
<p>before possible death from goblin - we need to jump over him</p>
<p><img src="/files/in_the_dark/before_goblin.png" alt="before_goblin.png"></p>
<p>after avoiding gobiln</p>
<p><img src="/files/in_the_dark/after_goblin.png" alt="after_goblin.png"></p>
<p>flag reached</p>
<p><img src="/files/in_the_dark/final.png" alt="final.png"></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span> ██▓ ███▄    █    ▄▄▄█████▓ ██░ ██ ▓█████    ▓█████▄  ▄▄▄       ██▀███   ██ ▄█▀
</span></span><span style="display:flex;"><span>▓██▒ ██ ▀█   █    ▓  ██▒ ▓▒▓██░ ██▒▓█   ▀    ▒██▀ ██▌▒████▄    ▓██ ▒ ██▒ ██▄█▒ 
</span></span><span style="display:flex;"><span>▒██▒▓██  ▀█ ██▒   ▒ ▓██░ ▒░▒██▀▀██░▒███      ░██   █▌▒██  ▀█▄  ▓██ ░▄█ ▒▓███▄░ 
</span></span><span style="display:flex;"><span>░██░▓██▒  ▐▌██▒   ░ ▓██▓ ░ ░▓█ ░██ ▒▓█  ▄    ░▓█▄   ▌░██▄▄▄▄██ ▒██▀▀█▄  ▓██ █▄ 
</span></span><span style="display:flex;"><span>░██░▒██░   ▓██░     ▒██▒ ░ ░▓█▒░██▓░▒████▒   ░▒████▓  ▓█   ▓██▒░██▓ ▒██▒▒██▒ █▄
</span></span><span style="display:flex;"><span>░▓  ░ ▒░   ▒ ▒      ▒ ░░    ▒ ░░▒░▒░░ ▒░ ░    ▒▒▓  ▒  ▒▒   ▓▒█░░ ▒▓ ░▒▓░▒ ▒▒ ▓▒
</span></span><span style="display:flex;"><span> ▒ ░░ ░░   ░ ▒░       ░     ▒ ░▒░ ░ ░ ░  ░    ░ ▒  ▒   ▒   ▒▒ ░  ░▒ ░ ▒░░ ░▒ ▒░
</span></span><span style="display:flex;"><span> ▒ ░   ░   ░ ░      ░       ░  ░░ ░   ░       ░ ░  ░   ░   ▒     ░░   ░ ░ ░░ ░ 
</span></span><span style="display:flex;"><span> ░           ░              ░  ░  ░   ░  ░      ░          ░  ░   ░     ░  ░   
</span></span><span style="display:flex;"><span>                                              ░
</span></span><span style="display:flex;"><span>Fellow mage lost in the darkness, he needs your guidance to find the flag as fast as possible and survive... 
</span></span><span style="display:flex;"><span>dwdwaawddddwdddwddddddwdwawddddddwdwddaaaaa
</span></span><span style="display:flex;"><span>Thank you for helping poor mage, in return you can see what he found.
</span></span><span style="display:flex;"><span>zeroday{goblin_also_cant_see_in_the_dark}
</span></span></code></pre></div>
		</section>

		<div class="post-tags">
			
			
			<nav class="nav tags">
				<ul class="tags">
					
					<li><a href="/tags/ctf">ctf</a></li>
					
					<li><a href="/tags/rev">rev</a></li>
					
					<li><a href="/tags/zeroday">zeroday</a></li>
					
				</ul>
			</nav>
			
			
		</div>
		</article>
</main>
<footer>
  <div style="display:flex"><a class="soc" href="https://github.com/pegielm" rel="me" title="GitHub"><i data-feather="github"></i></a>
    <a class="border"></a><a class="soc" href="https://x.com/pegielm/" rel="me" title="Twitter"><i data-feather="twitter"></i></a>
    <a class="border"></a></div>
  <div class="footer-info">
    2024   © pegielm |  <a
      href="https://github.com/athul/archie">Archie Theme</a> | Built with <a href="https://gohugo.io">Hugo</a>
  </div>
</footer>
<script>
  feather.replace()
</script></div>
    </body>
</html>
